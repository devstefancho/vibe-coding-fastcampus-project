# 토스페이먼츠 위젯 v2 연동 가이드

최근 통합 과정에서 마주친 문제와 해결책을 정리했습니다. 향후 구현 시 아래 내용을 참고하면 동일한 이슈를 예방할 수 있습니다.

## DOM 렌더 타이밍 관리
- `div#payment-method`, `div#agreement` 컨테이너는 초기에 반드시 DOM에 렌더링해야 합니다. 로딩 상태라는 이유로 요소 자체를 조건부 렌더링으로 제거하면 `renderPaymentMethods`/`renderAgreement`가 대상을 찾지 못합니다.
- 로딩 UI는 오버레이나 투명도 조절 방식으로 처리하고, 실제 컨테이너는 항상 DOM에 남겨둡니다.

## 위젯 인스턴스는 한 번만 생성
- `loadTossPayments()`와 `widgets()` 호출은 페이지당 한 번만 수행하세요. React 재렌더링으로 반복 호출되지 않도록 `useRef` 등에 인스턴스(또는 프라미스)를 캐시합니다.
- 이미 렌더된 위젯에 다시 `renderPaymentMethods`를 호출하면 "하나의 결제수단 위젯만을 사용할 수 있어요" 오류가 발생합니다. 재사용 시에는 `setAmount`만 호출해 금액을 갱신합니다.
- 초기화에 실패하면 캐시한 인스턴스/프라미스를 비워 다음 시도에서 새로 만들 수 있게 합니다.

## 호출 순서와 금액 갱신
- v2 위젯은 `renderPaymentMethods`/`renderAgreement` 전에 반드시 `setAmount`로 금액을 지정해야 합니다.
- 장바구니 합계가 변할 때는 기존 인스턴스를 재사용하며 `setAmount`만 다시 호출합니다. DOM을 갈아엎거나 위젯을 재생성할 필요가 없습니다.

## 고객 정보 포맷팅
- 전화번호는 숫자만 전달해야 합니다(`replace(/\D/g, '')`). 하이픈 등 특수문자가 포함되면 토스 위젯이 형식 오류를 반환합니다.
- 필수 입력값은 위젯 호출 전 프런트에서 검증해 사용자에게 명확한 피드백을 제공합니다.

## 로딩 UX 모범 사례
- 로딩 상태를 이유로 컨테이너를 제거하지 말고, 버튼 비활성화나 반투명 오버레이로 상태를 표현하세요.
- 결제 버튼은 위젯이 준비됐고(`widgets` 존재), 로딩이 끝난 경우에만 활성화합니다.

## 디버그 체크리스트
1. 개발자 도구에서 초기 렌더 시 `#payment-method`, `#agreement` 요소가 존재하는지 확인합니다.
2. 콘솔에 뜨는 토스 오류 코드를 확인하고, 복구 불가한 오류라면 캐시된 위젯 레퍼런스를 초기화합니다.
3. 장바구니 금액을 바꿔보고 `setAmount`만 호출되는지, `render*`가 중복 실행되지 않는지 점검합니다.
4. 하이픈 포함/미포함 전화번호로 테스트해 포맷팅 로직이 잘 동작하는지 확인합니다.

## 참고 자료
- 토스 공식 문서: https://docs.tosspayments.com/llms.txt
- 동작 참고용 샘플: `tosspayments-sample/index.html`
