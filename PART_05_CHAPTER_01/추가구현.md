# 버킷리스트 앱 - 소셜 네트워킹 기능 추가 구현

## 변경 개요

기존의 개인 전용 버킷리스트 앱을 **소셜 네트워킹 앱**으로 전환하였습니다. 이제 사용자들은 서로의 버킷리스트를 확인하고 댓글을 통해 소통할 수 있습니다.

---

## 주요 변경 사항

### 1. 기획 변경 내용

#### 기존 기획
- 사용자는 **본인이 작성한 버킷리스트만** 조회 가능
- 사용자는 **본인의 버킷리스트에만** 댓글 작성 가능
- 완전히 개인적인 목표 관리 앱

#### 새로운 기획
- **모든 사용자의 버킷리스트**를 볼 수 있음
- **모든 버킷리스트에 댓글** 작성 가능
- 다른 사람들과 목표를 공유하고 소통하는 소셜 앱
- 본인 데이터의 **수정/삭제 권한은 유지**

---

## 구현 상세

### 1. 데이터베이스 변경

#### 1.1 버킷리스트 테이블 RLS 정책 변경

**마이그레이션 파일**: `update_bucket_lists_rls_for_social`

**변경 내용**:
```sql
-- 기존: 본인 버킷리스트만 조회
WHERE auth.uid() = user_id

-- 신규: 모든 인증된 사용자가 조회 가능
WHERE auth.role() = 'authenticated'
```

**적용된 정책**:
- ✅ **SELECT**: 모든 인증된 사용자가 모든 버킷리스트 조회 가능
- ✅ **INSERT**: 본인 것만 생성 가능 (변경 없음)
- ✅ **UPDATE**: 본인 것만 수정 가능 (변경 없음)
- ✅ **DELETE**: 본인 것만 삭제 가능 (변경 없음)

#### 1.2 댓글 테이블 RLS 정책 변경

**마이그레이션 파일**: `update_comments_rls_for_social`

**변경 내용**:
```sql
-- 기존: 본인 버킷리스트의 댓글만 조회
WHERE bucket_list.user_id = auth.uid()

-- 신규: 모든 댓글 조회 가능
WHERE auth.role() = 'authenticated'
```

**적용된 정책**:
- ✅ **SELECT**: 모든 인증된 사용자가 모든 댓글 조회 가능
- ✅ **INSERT**: 모든 인증된 사용자가 모든 버킷리스트에 댓글 작성 가능
- ✅ **DELETE**: 본인이 작성한 댓글만 삭제 가능 (변경 없음)

---

### 2. UI/UX 변경

#### 2.1 버킷리스트 목록 화면 (BucketListScreen)

**추가된 기능**:

1. **필터 기능**
   - "All" 버튼: 모든 사용자의 버킷리스트 표시 (기본값)
   - "Mine" 버튼: 본인의 버킷리스트만 표시

   ```tsx
   <View style={styles.filterContainer}>
     <TouchableOpacity
       style={[styles.filterButton, filterMode === 'all' && styles.filterButtonActive]}
       onPress={() => setFilterMode('all')}
     >
       <Text>All</Text>
     </TouchableOpacity>
     <TouchableOpacity
       style={[styles.filterButton, filterMode === 'mine' && styles.filterButtonActive]}
       onPress={() => setFilterMode('mine')}
     >
       <Text>Mine</Text>
     </TouchableOpacity>
   </View>
   ```

2. **실시간 업데이트**
   - 모든 버킷리스트 변경사항을 실시간으로 구독
   - 다른 사용자가 추가한 버킷리스트도 즉시 표시

3. **작성자 정보 표시**
   - 각 버킷리스트 항목에 작성자 이메일 표시
   - 본인 것은 이메일 전체 표시
   - 타인 것은 user_id 일부만 표시 (프라이버시 고려)

#### 2.2 버킷리스트 항목 (BucketListItem)

**추가된 기능**:

1. **본인 항목 시각적 구분**
   - 왼쪽 파란색 테두리 표시
   - "Mine" 배지 표시

   ```tsx
   {isOwnItem && (
     <View style={styles.ownBadge}>
       <Text style={styles.ownBadgeText}>Mine</Text>
     </View>
   )}
   ```

2. **작성자 정보**
   - 하단에 "By: [이메일]" 형식으로 작성자 표시

   ```tsx
   {item.user_email && (
     <Text style={styles.author}>
       By: {item.user_email}
     </Text>
   )}
   ```

#### 2.3 버킷리스트 상세 화면 (DetailScreen)

**추가된 권한 기반 UI**:

1. **읽기 전용 모드**
   - 타인의 버킷리스트를 볼 때:
     - ❌ 수정 버튼 숨김
     - ❌ 완료 토글 버튼 숨김
     - ❌ 삭제 버튼 숨김
     - ⚠️ 읽기 전용 배지 표시

   ```tsx
   const isOwnItem = session?.user.id === bucketList.user_id;

   {!isOwnItem && (
     <View style={styles.readOnlyBadge}>
       <Text style={styles.readOnlyText}>
         👁️ Read-only (Not your bucket list)
       </Text>
     </View>
   )}
   ```

2. **조건부 액션 버튼**
   - 본인의 버킷리스트일 때만 수정/삭제 버튼 표시

   ```tsx
   {isOwnItem && (
     <View style={styles.actionsSection}>
       <TouchableOpacity onPress={handleToggleComplete}>
         <Text>Mark as Complete</Text>
       </TouchableOpacity>
       <TouchableOpacity onPress={handleDelete}>
         <Text>Delete</Text>
       </TouchableOpacity>
     </View>
   )}
   ```

3. **작성자 정보 표시**
   - 상단에 작성자 이메일 표시

#### 2.4 댓글 섹션 (CommentSection)

**기존 구현이 이미 소셜 기능 지원**:
- ✅ 모든 사용자가 댓글 작성 가능
- ✅ 모든 댓글 조회 가능
- ✅ 본인 댓글만 삭제 가능
- ✅ 실시간 업데이트

RLS 정책 변경으로 이제 정상적으로 작동합니다.

---

### 3. 타입 정의 변경

**파일**: `lib/types.ts`

```typescript
export interface BucketList {
  id: string;
  title: string;
  content: string;
  completed: boolean;
  user_id: string;
  created_at: string;
  updated_at: string;
  user_email?: string; // 추가: 작성자 이메일 (선택적)
}
```

---

## 보안 및 권한 정책

### RLS 정책 요약

| 테이블 | 작업 | 권한 | 설명 |
|--------|------|------|------|
| bucket_lists | SELECT | 모든 인증 사용자 | 모든 버킷리스트 조회 가능 |
| bucket_lists | INSERT | 본인만 | 본인 것만 생성 가능 |
| bucket_lists | UPDATE | 본인만 | 본인 것만 수정 가능 |
| bucket_lists | DELETE | 본인만 | 본인 것만 삭제 가능 |
| comments | SELECT | 모든 인증 사용자 | 모든 댓글 조회 가능 |
| comments | INSERT | 모든 인증 사용자 | 모든 버킷리스트에 댓글 작성 가능 |
| comments | DELETE | 본인만 | 본인 댓글만 삭제 가능 |

### 보안 강점

1. **인증 필수**: 모든 작업에 인증이 필요
2. **데이터 무결성**: 본인 데이터만 수정/삭제 가능
3. **RLS 적용**: 데이터베이스 레벨에서 권한 보호
4. **UI 레벨 검증**: 프론트엔드에서도 권한 체크

---

## 사용자 경험 개선

### 1. 시각적 구분

- **본인 버킷리스트**: 파란색 왼쪽 테두리 + "Mine" 배지
- **타인 버킷리스트**: 기본 스타일
- **읽기 전용**: 노란색 경고 배지

### 2. 필터링

- 전체 보기 / 내 것만 보기 전환 가능
- 필터 상태에 따른 빈 화면 메시지 변경

### 3. 실시간 업데이트

- 버킷리스트 추가/수정/삭제 시 즉시 반영
- 댓글 추가/삭제 시 즉시 반영

---

## 테스트 체크리스트

### 기본 기능
- [ ] 로그인/회원가입
- [ ] 버킷리스트 생성
- [ ] 본인 버킷리스트 수정
- [ ] 본인 버킷리스트 삭제
- [ ] 본인 버킷리스트 완료 토글

### 소셜 기능
- [ ] 모든 사용자의 버킷리스트 조회
- [ ] 필터 전환 (All ↔ Mine)
- [ ] 타인 버킷리스트 상세 조회
- [ ] 타인 버킷리스트에 댓글 작성
- [ ] 본인 댓글 삭제
- [ ] 타인 댓글 삭제 시도 (실패해야 함)

### 권한 검증
- [ ] 타인 버킷리스트 수정 시도 (UI에 버튼 없어야 함)
- [ ] 타인 버킷리스트 삭제 시도 (UI에 버튼 없어야 함)
- [ ] 타인 버킷리스트 완료 토글 시도 (UI에 버튼 없어야 함)
- [ ] 읽기 전용 배지 표시 확인

### UI/UX
- [ ] 본인 버킷리스트 시각적 구분 확인
- [ ] 작성자 이메일 표시 확인
- [ ] 실시간 업데이트 확인
- [ ] 필터 버튼 활성 상태 확인

---

## 향후 개선 사항

### 단기
1. **프로필 기능**
   - 사용자 닉네임 설정
   - 프로필 이미지 추가

2. **검색 기능**
   - 버킷리스트 제목/내용 검색
   - 사용자별 필터링

3. **좋아요 기능**
   - 버킷리스트에 좋아요 추가
   - 인기 버킷리스트 표시

### 중기
1. **알림 기능**
   - 내 버킷리스트에 댓글이 달리면 알림
   - 푸시 알림 지원

2. **카테고리/태그**
   - 버킷리스트 카테고리 분류
   - 태그 기반 탐색

3. **통계 기능**
   - 완료율 통계
   - 월별/연도별 달성 현황

### 장기
1. **친구 기능**
   - 친구 추가/관리
   - 친구 버킷리스트만 보기

2. **공동 버킷리스트**
   - 여러 사람이 함께 달성하는 목표
   - 공동 편집 기능

3. **챌린지 기능**
   - 버킷리스트 챌린지 개설
   - 참가자 모집 및 진행 상황 공유

---

## 마이그레이션 이력

### 2025-11-01

1. **update_bucket_lists_rls_for_social**
   - bucket_lists 테이블 SELECT 정책 변경
   - 모든 인증된 사용자가 조회 가능하도록 수정

2. **update_comments_rls_for_social**
   - comments 테이블 RLS 정책 전면 개편
   - SELECT: 모든 인증 사용자 가능
   - INSERT: 모든 인증 사용자 가능
   - DELETE: 본인만 가능

---

## 기술적 고려사항

### 성능 최적화
- 사용자 이메일 조회 시 Supabase auth.users 직접 접근 제한으로 인해 현재는 user_id 일부만 표시
- 향후 개선:
  - users 테이블에 email 컬럼 복제
  - 또는 Supabase RPC 함수 생성하여 이메일 조회

### 실시간 기능
- Supabase Realtime 구독을 통한 즉각적인 UI 업데이트
- 채널별 구독으로 불필요한 업데이트 방지

### 데이터 프라이버시
- 타인의 이메일은 전체 표시하지 않음 (선택적)
- RLS 정책으로 데이터베이스 레벨에서 보호

---

## 결론

버킷리스트 앱이 개인 목표 관리 도구에서 **소셜 네트워킹 플랫폼**으로 성공적으로 전환되었습니다.

주요 성과:
- ✅ 모든 사용자의 버킷리스트 공유
- ✅ 댓글을 통한 소통 기능
- ✅ 권한 기반 UI로 보안 유지
- ✅ 실시간 업데이트로 사용자 경험 개선

다음 단계로 검색, 좋아요, 알림 등의 기능을 추가하여 더욱 풍부한 소셜 경험을 제공할 수 있습니다.
